{% extends "base.html" %}

{% block title %}DSA Algorithm Chatbot{% endblock %}

{% block content %}
<div id="app-container">
    <!-- Sidebar for chat history -->
    <div id="sidebar">
        <div class="sidebar-header">
            <h3>Conversations</h3>
            <button id="new-chat-btn">+ New Chat</button>
        </div>
        <div id="conversations-list">
            <!-- Conversations will be loaded here -->
        </div>
    </div>
    
    <!-- Main chat area -->
    <div id="main-content">
        <div id="chat-header">
            <h4 id="current-title">New Conversation</h4>
        </div>
        <div id="messages-container">
            <div id="messages">
                <div class="welcome-message">
                    <h3>DSA Algorithm Helper</h3>
                    <p>Ask me about algorithms, data structures, and problem-solving approaches!</p>
                </div>
            </div>
        </div>
        <div id="input-area">
            <textarea id="user-input" placeholder="Ask about algorithms, data structures, or DSA problems..."></textarea>
            <button id="send-btn">Send</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    :root {
        --bg-color: #ffffff;
        --text-color: #000000;
        --sidebar-bg: #f0f0f0;
        --message-user-bg: #d9eaf7;
        --message-assistant-bg: #f0f0f0;
        --border-color: #cccccc;
        --input-bg: #ffffff;
    }
    
    body {
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
    }
    
    #app-container {
        display: flex;
        height: 100vh;
    }
    
    /* Sidebar styles */
    #sidebar {
        width: 250px;
        background-color: var(--sidebar-bg);
        border-right: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
    }
    
    .sidebar-header {
        padding: 15px;
        border-bottom: 1px solid var(--border-color);
    }
    
    .sidebar-header h3 {
        margin: 0 0 10px 0;
    }
    
    #new-chat-btn {
        width: 100%;
        padding: 8px;
        background-color: #000000;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    
    #conversations-list {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
    }
    
    .conversation-item {
        padding: 8px;
        margin-bottom: 5px;
        background-color: #e0e0e0;
        border-radius: 4px;
        cursor: pointer;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .conversation-item:hover {
        background-color: #d0d0d0;
    }
    
    .conversation-item.active {
        background-color: #000000;
        color: white;
    }
    
    /* Main content styles */
    #main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
    }
    
    #chat-header {
        padding: 15px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    #chat-header h4 {
        margin: 0;
    }
    
    #messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
    }
    
    .welcome-message {
        text-align: center;
        padding: 40px 0;
        color: #666;
    }
    
    .message {
        margin-bottom: 15px;
        padding: 10px;
        border-radius: 8px;
        max-width: 80%;
    }
    
    .user-message {
        background-color: var(--message-user-bg);
        margin-left: auto;
        margin-right: 0;
    }
    
    .assistant-message {
        background-color: var(--message-assistant-bg);
        margin-right: auto;
        margin-left: 0;
    }
    
    .message-header {
        font-weight: bold;
        margin-bottom: 5px;
        font-size: 0.9em;
    }
    
    /* Input area styles */
    #input-area {
        padding: 15px;
        border-top: 1px solid var(--border-color);
        display: flex;
    }
    
    #user-input {
        flex: 1;
        padding: 10px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        resize: none;
        height: 60px;
        background-color: var(--input-bg);
        color: var(--text-color);
    }
    
    #send-btn {
        margin-left: 10px;
        padding: 10px 20px;
        background-color: #000000;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    
    #send-btn:hover {
        background-color: #333333;
    }
    
    /* Markdown formatting */
    .message-content h1, .message-content h2, .message-content h3 {
        margin: 10px 0 5px 0;
        color: var(--text-color);
    }
    
    .message-content h1 { font-size: 1.4em; }
    .message-content h2 { font-size: 1.3em; }
    .message-content h3 { font-size: 1.2em; }
    
    .message-content p {
        margin: 8px 0;
        line-height: 1.5;
    }
    
    .message-content ul, .message-content ol {
        margin: 8px 0;
        padding-left: 20px;
    }
    
    .message-content li {
        margin-bottom: 4px;
    }
    
    .message-content code {
        background-color: #e9e9e9;
        padding: 2px 4px;
        border-radius: 3px;
        font-family: monospace;
    }
    
    .message-content pre {
        background-color: #e9e9e9;
        padding: 10px;
        border-radius: 4px;
        overflow-x: auto;
        margin: 10px 0;
    }
    
    .message-content pre code {
        background: none;
        padding: 0;
        display: block;
    }
    
    .message-content strong {
        font-weight: bold;
    }
    
    .message-content em {
        font-style: italic;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // DOM elements
    const messagesContainer = document.getElementById('messages');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const newChatBtn = document.getElementById('new-chat-btn');
    const conversationsList = document.getElementById('conversations-list');
    const currentTitle = document.getElementById('current-title');
    const themeToggle = document.getElementById('theme-toggle');
    
    // State
    let currentConversationId = null;
    const userId = 'default_user';
    
    // No theme functionality - using default light theme only
    
    // Helper function to escape HTML to prevent XSS
    function escapeHtml(unsafe) {
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }
    
    // Clean and format message content from AI models
    function formatMessage(text) {
        // Step 1: Clean up special artifacts from model responses
        text = text.replace(/\$[0-9]+\*/g, '');  // Remove $1*, $2*, etc.
        text = text.replace(/\$[0-9]+/g, '');    // Remove $1, $2, etc.
        text = text.replace(/\\\((.*?)\\\)/g, '<em>($1)</em>');  // Handle LaTeX-style math
        text = text.replace(/\\\[(.*?)\\\]/g, '<strong>[$1]</strong>');
        
        // Step 2: Handle markdown-style bold formatting with proper closing tags
        text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        
        // Step 3: Split into lines and process each line individually
        let lines = text.split('\n');
        let result = [];
        let inList = false;
        let listType = null; // 'ul' or 'ol'
        
        for (let i = 0; i < lines.length; i++) {
            let line = lines[i];
            let trimmedLine = line.trim();
            
            // Skip empty lines
            if (trimmedLine === '') {
                if (inList) {
                    result.push(`</${listType}>`);
                    inList = false;
                }
                continue;
            }
            
            // Check for headers (simple patterns)
            if (trimmedLine.startsWith('####')) {
                if (inList) result.push(`</${listType}>`);
                inList = false;
                result.push('<h4>' + escapeHtml(trimmedLine.replace(/^####\s*/, '')) + '</h4>');
            } 
            else if (trimmedLine.startsWith('###')) {
                if (inList) result.push(`</${listType}>`);
                inList = false;
                result.push('<h3>' + escapeHtml(trimmedLine.replace(/^###\s*/, '')) + '</h3>');
            } 
            else if (trimmedLine.startsWith('##')) {
                if (inList) result.push(`</${listType}>`);
                inList = false;
                result.push('<h2>' + escapeHtml(trimmedLine.replace(/^##\s*/, '')) + '</h2>');
            } 
            else if (trimmedLine.startsWith('#')) {
                if (inList) result.push(`</${listType}>`);
                inList = false;
                result.push('<h1>' + escapeHtml(trimmedLine.replace(/^#\s*/, '')) + '</h1>');
            }
            // Check for ordered lists (number followed by period)
            else if (trimmedLine.match(/^\d+\.\s/)) {
                const content = trimmedLine.replace(/^\d+\.\s/, '');
                
                if (!inList || listType !== 'ol') {
                    if (inList) result.push(`</${listType}>`);
                    result.push('<ol>');
                    inList = true;
                    listType = 'ol';
                }
                result.push('<li>' + escapeHtml(content) + '</li>');
            }
            // Check for unordered lists (dash, asterisk, or plus)
            else if (trimmedLine.match(/^[-*+]\s/)) {
                const content = trimmedLine.replace(/^[-*+]\s/, '');
                
                if (!inList || listType !== 'ul') {
                    if (inList) result.push(`</${listType}>`);
                    result.push('<ul>');
                    inList = true;
                    listType = 'ul';
                }
                result.push('<li>' + escapeHtml(content) + '</li>');
            }
            // Regular paragraph
            else {
                if (inList) {
                    result.push(`</${listType}>`);
                    inList = false;
                }
                
                // Apply inline formatting to the escaped line content
                let processedLine = escapeHtml(line);
                
                // Handle remaining inline formatting after escaping
                processedLine = processedLine
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')      // Emphasis
                    .replace(/_(.*?)_/g, '<em>$1</em>')        // Underline as emphasis
                    .replace(/`([^`]+)`/g, '<code>$1</code>'); // Inline code
                
                result.push('<p>' + processedLine + '</p>');
            }
        }
        
        // Close any open list at the end
        if (inList) {
            result.push(`</${listType}>`);
        }
        
        return result.join('');
    }
    
    // Add message to UI
    function addMessageToUI(role, content) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${role}-message`;
        
        const headerDiv = document.createElement('div');
        headerDiv.className = 'message-header';
        headerDiv.textContent = role === 'user' ? 'You' : 'Assistant';
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        contentDiv.innerHTML = formatMessage(content);
        
        messageDiv.appendChild(headerDiv);
        messageDiv.appendChild(contentDiv);
        
        messagesContainer.appendChild(messageDiv);
        
        // Auto-scroll to bottom
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    // Handle sending a message
    async function sendMessage() {
        const message = userInput.value.trim();
        if (!message) return;
        
        // Clear input
        userInput.value = '';
        
        // Add user message to UI
        addMessageToUI('user', message);
        
        try {
            // Show a simple "thinking" indicator
            const thinkingDiv = document.createElement('div');
            thinkingDiv.className = 'message assistant-message';
            thinkingDiv.innerHTML = '<div class="message-header">Assistant</div><div class="typing-indicator">Thinking...</div>';
            messagesContainer.appendChild(thinkingDiv);
            
            // Send message to backend
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: message,
                    user_id: userId,
                    conversation_id: currentConversationId
                })
            });
            
            // Remove thinking indicator
            thinkingDiv.remove();
            
            if (response.ok) {
                const data = await response.json();
                
                // Update conversation ID if new conversation was created
                if (data.conversation_id && !currentConversationId) {
                    currentConversationId = data.conversation_id;
                    loadConversations();
                }
                
                // Add assistant response to UI
                addMessageToUI('assistant', data.response);
            } else {
                addMessageToUI('assistant', 'Sorry, I encountered an error. Please try again.');
            }
        } catch (error) {
            // Remove thinking indicator
            thinkingDiv.remove();
            addMessageToUI('assistant', 'Sorry, I encountered an error. Please try again.');
        }
    }
    
    // Load conversations
    async function loadConversations() {
        try {
            const response = await fetch(`/api/history/conversations?user_id=${userId}`);
            if (response.ok) {
                const data = await response.json();
                conversationsList.innerHTML = '';
                
                data.conversations.forEach(conv => {
                    const item = document.createElement('div');
                    item.className = `conversation-item ${conv._id === currentConversationId ? 'active' : ''}`;
                    item.textContent = conv.title || 'Untitled';
                    item.dataset.id = conv._id;
                    
                    item.addEventListener('click', () => {
                        loadConversation(conv._id);
                    });
                    
                    conversationsList.appendChild(item);
                });
            }
        } catch (error) {
            console.error('Error loading conversations:', error);
        }
    }
    
    // Load a specific conversation
    async function loadConversation(conversationId) {
        try {
            const response = await fetch(`/api/conversation/${conversationId}?user_id=${userId}`);
            if (response.ok) {
                const data = await response.json();
                
                currentConversationId = conversationId;
                currentTitle.textContent = data.conversation.title || 'Conversation';
                
                // Clear messages and load conversation
                messagesContainer.innerHTML = '';
                data.messages.forEach(msg => {
                    addMessageToUI(msg.role, msg.content);
                });
                
                // Update active conversation in list
                document.querySelectorAll('.conversation-item').forEach(item => {
                    item.classList.toggle('active', item.dataset.id === conversationId);
                });
            }
        } catch (error) {
            console.error('Error loading conversation:', error);
        }
    }
    
    // Event listeners
    sendBtn.addEventListener('click', sendMessage);
    
    userInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    
    newChatBtn.addEventListener('click', () => {
        currentConversationId = null;
        currentTitle.textContent = 'New Conversation';
        messagesContainer.innerHTML = '<div class="welcome-message"><h3>DSA Algorithm Helper</h3><p>Ask me about algorithms, data structures, and problem-solving approaches!</p></div>';
        loadConversations();
    });
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
        loadConversations();
    });
</script>
{% endblock %}